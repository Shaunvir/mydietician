<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Dietitian - MyDietitian</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-container {
            background: white;
            padding: 48px;
            border-radius: 24px;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.06);
            max-width: 480px;
            width: 100%;
            margin: 20px;
        }

        .search-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .search-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .search-subtitle {
            color: #6366f1;
            font-weight: 600;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 18px;
            z-index: 2;
        }

        .form-input {
            width: 100%;
            padding: 16px 16px 16px 50px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
        }

        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .form-select {
            width: 100%;
            padding: 16px 50px 16px 50px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 16px center;
            background-repeat: no-repeat;
            background-size: 16px;
        }

        .form-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-button {
            width: 100%;
            background: #6366f1;
            color: white;
            padding: 18px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            margin-top: 32px;
        }

        .search-button:hover {
            background: #5048e5;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-icon {
            font-size: 20px;
        }

        /* Back link */
        .back-link {
            position: absolute;
            top: 24px;
            left: 24px;
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #374151;
        }

        .validation-message {
            background: #ecfdf5;
            border: 1px solid #bbf7d0;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            display: none;
        }

        .validation-message.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .validation-message.warning {
            background: #fffbeb;
            border-color: #fed7aa;
            color: #d97706;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .search-container {
                padding: 32px 24px;
                margin: 16px;
                border-radius: 16px;
            }

            .search-title {
                font-size: 24px;
            }

            .form-input,
            .form-select {
                padding: 14px 14px 14px 46px;
                font-size: 15px;
            }

            .search-button {
                padding: 16px 20px;
                font-size: 15px;
            }

            .back-link {
                position: static;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Home</a>
    
    <div class="search-container">
        <div class="search-header">
            <h1 class="search-title">Find a dietitian</h1>
            <p class="search-subtitle">covered by insurance</p>
        </div>

        <div class="validation-message" id="validationMessage"></div>

        <form id="searchForm" action="results.html" method="GET">
            <div class="form-group">
                <label for="name">Full Name*</label>
                <div class="input-wrapper">
                    <span class="input-icon">üë§</span>
                    <input type="text" class="form-input" name="name" id="name" required placeholder="Enter your full name">
                </div>
            </div>

            <div class="form-group">
                <label for="email">Email Address*</label>
                <div class="input-wrapper">
                    <span class="input-icon">üìß</span>
                    <input type="email" class="form-input" name="email" id="email" required placeholder="Enter your email address">
                </div>
            </div>

            <div class="form-group">
                <label for="phone">Phone Number*</label>
                <div class="input-wrapper">
                    <span class="input-icon">üìû</span>
                    <input type="tel" class="form-input" name="phone" id="phone" required placeholder="Enter your phone number">
                </div>
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <span class="input-icon">üìç</span>
                    <select class="form-select" name="location" id="location" required>
                        <option value="">Province*</option>
                        <option value="Alberta">Alberta</option>
                        <option value="British Columbia">British Columbia</option>
                        <option value="Manitoba">Manitoba</option>
                        <option value="New Brunswick">New Brunswick</option>
                        <option value="Newfoundland and Labrador">Newfoundland and Labrador</option>
                        <option value="Nova Scotia">Nova Scotia</option>
                        <option value="Ontario">Ontario</option>
                        <option value="Prince Edward Island">Prince Edward Island</option>
                        <option value="Quebec">Quebec</option>
                        <option value="Saskatchewan">Saskatchewan</option>
                        <option value="Northwest Territories">Northwest Territories</option>
                        <option value="Nunavut">Nunavut</option>
                        <option value="Yukon">Yukon</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <span class="input-icon">üè•</span>
                    <select class="form-select" name="insurance" id="insurance" required>
                        <option value="">Insurance*</option>
                        <option value="Canada Life">Canada Life</option>
                        <option value="Sun Life Financial">Sun Life Financial</option>
                        <option value="Manulife">Manulife</option>
                        <option value="Great-West Life">Great-West Life</option>
                        <option value="Blue Cross">Blue Cross</option>
                        <option value="Chambers of Commerce Group Insurance">Chambers of Commerce Group Insurance</option>
                        <option value="Desjardins Insurance">Desjardins Insurance</option>
                        <option value="Industrial Alliance">Industrial Alliance</option>
                        <option value="Medavie Blue Cross">Medavie Blue Cross</option>
                        <option value="Green Shield Canada">Green Shield Canada</option>
                        <option value="GroupHEALTH">GroupHEALTH</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <span class="input-icon">‚≠ê</span>
                    <select class="form-select" name="specialty" id="specialty">
                        <option value="">Specialties</option>
                        <option value="Weight Management">Weight Management</option>
                        <option value="Diabetes Management">Diabetes Management</option>
                        <option value="Heart Health">Heart Health</option>
                        <option value="Gut Health">Gut Health</option>
                        <option value="Sports Nutrition">Sports Nutrition</option>
                        <option value="Eating Disorders">Eating Disorders</option>
                        <option value="Pregnancy & Postpartum">Pregnancy & Postpartum</option>
                        <option value="Pediatric Nutrition">Pediatric Nutrition</option>
                        <option value="Food Allergies & Sensitivities">Food Allergies & Sensitivities</option>
                        <option value="General Nutrition">General Nutrition</option>
                        <option value="Autoimmune Conditions">Autoimmune Conditions</option>
                        <option value="Cancer Nutrition">Cancer Nutrition</option>
                        <option value="PCOS">PCOS</option>
                        <option value="Menopause">Menopause</option>
                        <option value="High Blood Pressure">High Blood Pressure</option>
                        <option value="High Cholesterol">High Cholesterol</option>
                        <option value="Kidney Disease">Kidney Disease</option>
                        <option value="Transplant Nutrition">Transplant Nutrition</option>
                        <option value="Vegan & Vegetarian">Vegan & Vegetarian</option>
                        <option value="Oral Health">Oral Health</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="member-id">Member ID*</label>
                <div class="input-wrapper">
                    <span class="input-icon">üÜî</span>
                    <input type="text" class="form-input" name="member_id" id="member-id" required placeholder="From your benefits card">
                </div>
            </div>

            <div class="form-group">
                <label for="group-number">Group Number (if applicable)</label>
                <div class="input-wrapper">
                    <span class="input-icon">üë•</span>
                    <input type="text" class="form-input" name="group_number" id="group-number" placeholder="Optional - if shown on your card">
                </div>
            </div>

            <button type="submit" class="search-button">
                <span class="search-icon">üîç</span>
                Search
            </button>
        </form>
    </div>

    <script>
        const SHEET_MONKEY_URL = 'https://api.sheetmonkey.io/form/9MoRQbyaVfkrCsZGZW3Mt2';
        // TODO: Replace with your Formspree endpoint for my.dietitian.ca@gmail.com
        const FORMSPREE_URL = 'https://formspree.io/f/xeozkgvr'; // Replace with actual Formspree endpoint

        async function submitToSheetMonkey(formData) {
            try {
                const response = await fetch(SHEET_MONKEY_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Sheet Monkey typically returns a 200 status for successful submissions
                return true;
            } catch (error) {
                console.error('Sheet Monkey submission failed:', error);
                throw error;
            }
        }

        async function submitToFormspree(formData) {
            try {
                // Add Formspree configuration fields
                formData.append('_subject', 'New Dietitian Search Form Submission');
                formData.append('_autoresponse', 'Thanks! We received your dietitian search request and will get back to you within 3-5 business days. Our team will help match you with a registered dietitian in your area.');
                formData.append('_captcha', 'false');
                
                const response = await fetch(FORMSPREE_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return true;
            } catch (error) {
                console.error('Formspree email submission failed:', error);
                throw error;
            }
        }

        async function submitDualData(formData) {
            let sheetMonkeySuccess = false;
            let formspreeSuccess = false;
            let errors = [];

            // Try both submissions in parallel
            try {
                await Promise.allSettled([
                    submitToSheetMonkey(new FormData(document.getElementById('searchForm'))),
                    submitToFormspree(new FormData(document.getElementById('searchForm')))
                ]).then(results => {
                    if (results[0].status === 'fulfilled') {
                        sheetMonkeySuccess = true;
                    } else {
                        errors.push('Database storage failed');
                        console.error('SheetMonkey failed:', results[0].reason);
                    }
                    
                    if (results[1].status === 'fulfilled') {
                        formspreeSuccess = true;
                    } else {
                        errors.push('Email notification failed');
                        console.error('Formspree failed:', results[1].reason);
                    }
                });

                // Require at least one to succeed
                if (!sheetMonkeySuccess && !formspreeSuccess) {
                    throw new Error('Both database and email submissions failed');
                }

                return {
                    success: true,
                    sheetMonkey: sheetMonkeySuccess,
                    email: formspreeSuccess,
                    errors: errors
                };
            } catch (error) {
                console.error('Dual submission failed:', error);
                throw error;
            }
        }

        function showValidationMessage(message, type = 'success') {
            const messageElement = document.getElementById('validationMessage');
            messageElement.textContent = message;
            messageElement.className = 'validation-message';
            
            if (type === 'error') {
                messageElement.classList.add('error');
            } else if (type === 'warning') {
                messageElement.classList.add('warning');
            }
            
            messageElement.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }

        // Simplified insurance validation - no scanning required
        function validateInsuranceData() {
            const memberID = document.getElementById('member-id').value;
            const insurance = document.getElementById('insurance').value;
            
            // Basic validation - just check if fields are filled
            if (!memberID || !insurance) {
                showValidationMessage('‚ùå Please provide both Member ID and Insurance Provider to continue.', 'error');
                return false;
            }
            
            return true;
        }

        // Handle form validation for both scanned and manual data
        function validateFormData() {
            const memberID = document.getElementById('member-id').value;
            const insurance = document.getElementById('insurance').value;
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const location = document.getElementById('location').value;
            
            // Check required fields
            if (!name || !email || !phone || !location || !memberID || !insurance) {
                showValidationMessage('‚ùå Please fill in all required fields to continue.', 'error');
                return false;
            }
            
            return true;
        }
        
        // Update form submission to use dual submission (database + email)
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // First validate form data
            if (!validateFormData()) {
                return;
            }
            
            // Then validate insurance data (simplified - no scanning required)
            if (!validateInsuranceData()) {
                return;
            }
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="search-icon">‚è≥</span> Submitting...';
            
            try {
                // Submit to both database and email
                const result = await submitDualData(formData);
                
                // Show success message with details
                let successMessage = '‚úÖ Your request has been submitted successfully!';
                if (result.errors.length > 0) {
                    successMessage += ' Note: ' + result.errors.join(', ') + '.';
                }
                showValidationMessage(successMessage, 'success');
                
                // Build URL parameters for results page (non-sensitive data only)
                const params = new URLSearchParams();
                for (let [key, value] of formData.entries()) {
                    // Skip sensitive personal data from URL, only include search filters
                    if (['location', 'insurance', 'specialty'].includes(key) && value) {
                        params.append(key, value);
                    }
                }
                
                // Redirect to results page after brief delay
                setTimeout(() => {
                    window.location.href = 'results.html?' + params.toString();
                }, 1500);
                
            } catch (error) {
                // Reset button state on error
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                
                // Show user-friendly error message
                showValidationMessage('‚ùå There was an error submitting your information. Please try again.', 'error');
            }
        });

        // Basic form validation for dropdown
        document.getElementById('location').addEventListener('change', function() {
            if (this.value) {
                this.style.borderColor = '#6366f1';
            }
        });

        // Initialize the form on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Form is ready to use - no scanning setup needed
            console.log('Dietitian search form initialized');
        });
    </script>
</body>
</html>